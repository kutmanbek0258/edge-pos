# Полное определение архитектуры системы Edge POS/WMS

## 1. Цели архитектуры

Архитектура системы должна обеспечивать:

- автономную (offline-first) работу торговой точки;
- высокую отказоустойчивость на одном edge-устройстве;
- предсказуемое поведение при сбоях питания и сети;
- строгую сетевую и сервисную изоляцию;
- возможность поэтапного масштабирования и развития.

Архитектура ориентирована на эксплуатацию **на SBC Orange Pi 5** без использования контейнеризации в production.

---

## 2. Архитектурный стиль

### 2.1 Общий стиль

- **Микросервисная архитектура (logical microservices)**
- **Edge-first / Offline-first**
- **Single-node deployment**

Физически все сервисы работают на одном узле, но:
- имеют отдельные процессы;
- отдельные конфигурации;
- изолированы средствами ОС.

---

## 3. Уровни архитектуры

### 3.1 Уровень клиента (Client Layer)

**Технологии:**
- Vue.js (SPA)
- HTML5 / CSS3
- Web APIs (camera / keyboard)

**Назначение:**
- пользовательский интерфейс кассира и кладовщика;
- ввод данных и отображение состояния системы;
- работа через браузер без установки ПО.

Клиент взаимодействует **только с API Gateway**.

---

### 3.2 Уровень доступа (Access Layer)

#### API Gateway

**Технологии:**
- Spring Cloud Gateway
- HTTPS
- JWT

**Функции:**
- единая точка входа;
- маршрутизация запросов;
- проверка JWT;
- CORS;
- rate limiting;
- логирование доступа.

Gateway не содержит бизнес-логики.

---

### 3.3 Уровень безопасности (Security Layer)

#### Authorization Service

**Технологии:**
- Spring Authorization Server
- OAuth2
- JWT

**Функции:**
- аутентификация пользователей;
- выдача и проверка токенов;
- управление ролями и правами;
- поддержка offline-токенов.

---

### 3.4 Бизнес-уровень (Business Layer)

#### POS Service

**Назначение:**
- кассовые операции;
- формирование чеков;
- расчёт налогов и скидок;
- генерация событий продаж.

#### WMS Service

**Назначение:**
- складские операции;
- управление остатками;
- инвентаризация;
- складские события.

#### Catalog Service

**Назначение:**
- товары;
- штрихкоды;
- цены;
- единицы измерения.

#### Search Service

**Назначение:**
- полнотекстовый поиск по товарам;
- индексация данных из Kafka в Elasticsearch.


Бизнес-сервисы:
- не имеют прямого доступа из LAN;
- взаимодействуют друг с другом через HTTP (localhost) и события.

---

### 3.5 Интеграционный уровень (Integration Layer)

#### Printer Service

**Технологии:**
- escpos-coffee
- TCP/IP

**Функции:**
- печать чеков;
- управление принтерами;
- шаблоны чеков.

#### OFD Sync Service

**Функции:**
- асинхронная отправка чеков в ОФД;
- повторные попытки;
- контроль статусов.

#### License Service

**Функции:**
- генерация hardware fingerprint;
- проверка лицензии;
- offline grace-period.

---

## 4. Взаимодействие сервисов

### 4.1 Синхронное взаимодействие

- Протокол: HTTP/REST
- Формат: JSON
- Сеть: localhost

Используется для:
- чтения данных;
- валидации;
- простых операций.

---

### 4.2 Асинхронное взаимодействие

**Технологии:**
- Apache Kafka (KRaft mode)

Используется для:
- чеков;
- событий продаж;
- складских событий;
- событий изменения каталога (для поиска);
- интеграций.

События являются основой offline-first модели.

---

## 5. Хранение данных

### 5.1 СУБД

**PostgreSQL**

Причины выбора:
- надёжность;
- ACID;
- хорошая работа на ARM;
- WAL.

### 5.2 Модель БД

- Одна инстанция PostgreSQL
- Разделение по схемам:
  - auth
  - pos
  - wms
  - catalog
  - system

---
### 5.3 Поисковый индекс

**Elasticsearch**

- Используется для полнотекстового поиска товаров.
- Не является источником истины, данные восстанавливаются из Kafka.

---

## 6. Управление процессами

### 6.1 Запуск сервисов

- systemd
- автоматический рестарт
- строгие зависимости

### 6.2 Изоляция

- отдельные Linux users;
- systemd sandboxing;
- firewall.

---

## 7. Сетевая архитектура

- API Gateway: доступ из LAN
- Все сервисы: bind 127.0.0.1
- PostgreSQL: localhost only

Исходящий интернет-доступ ограничен.

---

## 8. Отказоустойчивость

- Restart policies
- WAL в PostgreSQL
- Очереди событий
- Graceful degradation

Отказ одного сервиса не блокирует POS.

---

## 9. Выбор технологий (summary)

| Область | Технология |
|------|-----------|
| Backend | Java 17 + Spring Boot |
| Gateway | Spring Cloud Gateway |
| Auth | Spring Authorization Server |
| DB | PostgreSQL |
| Search | Elasticsearch |
| Queue | Apache Kafka (KRaft) |
| Frontend | Vue.js |
| Printing | escpos-coffee |
| OS | Linux (Armbian/Ubuntu) |
| Process Mgmt | systemd |

---

## 10. Эволюция архитектуры

Архитектура допускает:

- вынос сервисов на отдельные узлы;
- подключение центрального сервера;
- частичную контейнеризацию вне edge;
- масштабирование без переписывания логики.

---

## 11. Архитектурный вывод

Система представляет собой:

- промышленное edge-решение;
- отказоустойчивую POS/WMS платформу;
- основу для распределённой торговой сети.

Архитектура оптимизирована под реальные условия эксплуатации и ограничения SBC.

---

**Конец архитектурного описания**

