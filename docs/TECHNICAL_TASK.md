# Техническое задание (ТЗ)

## 1. Общие сведения

### 1.1 Наименование системы
Edge-система управления торговлей и складом (POS + WMS) с offline-first архитектурой на базе SBC **Orange Pi 5**.

### 1.2 Назначение системы
Система предназначена для автоматизации розничной торговли и складского учёта с возможностью автономной работы без доступа к сети Интернет.

Интернет используется **исключительно** для:
- активации и проверки лицензии;
- взаимодействия с API ОФД.

### 1.3 Условия эксплуатации
- Аппаратная платформа: Orange Pi 5 (ARM64, RK3588, ≥8GB RAM)
- ОС: Linux (Armbian / Ubuntu Server)
- Режим эксплуатации: 24/7
- Возможные аварийные отключения питания

---

## 2. Архитектурные требования

### 2.1 Общая архитектура

Система строится по **микросервисной архитектуре**, развёрнутой на одном edge-устройстве.

Принципы:
- Offline-first
- Минимальное потребление ресурсов
- Отказоустойчивость
- Централизованный вход через API Gateway

### 2.2 Физическая модель развёртывания

- Все сервисы запускаются как **systemd-сервисы**
- Контейнеризация **не используется** на production edge-узле
- Все сервисы работают локально

---

## 3. Состав системы

### 3.1 Backend-сервисы (Spring Boot)

| Сервис | Назначение |
|------|-----------|
| api-gateway | Единственная точка входа (HTTPS) |
| auth-service | OAuth2 Authorization Server |
| pos-service | Продажи, чеки, кассовые операции |
| wms-service | Складской учёт |
| search-service | Полнотекстовый поиск товаров |
| catalog-service | Товары, штрихкоды, цены |
| printer-service | Печать чеков (ESC/POS) |
| ofd-sync-service | Асинхронная отправка чеков в ОФД |
| license-service | Лицензирование и привязка к устройству |

### 3.2 Frontend

- Web SPA (Vue.js)
- Доступ по LAN через браузер
- Поддержка сканирования штрихкодов (Web APIs)

---

## 4. Сетевые и security-требования

### 4.1 Сетевая модель

- Внешний доступ (LAN): **только API Gateway**
- Все остальные сервисы доступны **только через localhost**

```
LAN → API Gateway → Internal Services (127.0.0.1)
```

### 4.2 Binding

- api-gateway: `0.0.0.0:443`
- все остальные сервисы: `127.0.0.1`

### 4.3 Firewall

- Default deny
- Разрешено:
  - 443/tcp (API Gateway)
  - 22/tcp (SSH обслуживание)
  - loopback

### 4.4 Ограничение egress

- Доступ в Интернет разрешён **только**:
  - ofd-sync-service
  - license-service

### 4.5 systemd sandboxing (обязательно)

- NoNewPrivileges
- ProtectSystem=strict
- ProtectHome
- PrivateTmp
- IPAddressDeny=any
- IPAddressAllow=127.0.0.1

---

## 5. Порядок запуска сервисов

### 5.1 Уровни запуска

1. ОС и сеть
2. Инфраструктура:
   - PostgreSQL
   - Apache Kafka
   - Elasticsearch
3. Core backend:
   - auth-service
   - catalog-service
   - pos-service
   - wms-service
   - search-service
4. Edge-сервисы:
   - printer-service
   - ofd-sync-service
   - license-service
5. API Gateway

### 5.2 Зависимости

- Все backend-сервисы зависят от PostgreSQL
- API Gateway зависит от всех core-сервисов

---

## 6. Хранение данных

### 6.1 База данных

- PostgreSQL (single instance)
- Отдельные схемы:
  - auth
  - pos
  - wms
  - catalog
  - system

### 6.2 Ограничения БД

- listen_addresses = '127.0.0.1'
- Доступ только по SCRAM-SHA-256

---

## 7. Offline-first логика

### 7.1 Основные принципы

- Все операции фиксируются локально
- Отсутствие интернета не блокирует продажи
- Внешние интеграции — асинхронные

### 7.2 Очереди

- Используется Apache Kafka (KRaft mode)
- Назначение:
  - Очередь чеков для ОФД
  - Очередь для индексации товаров в Elasticsearch
  - Повторы при ошибках

### 7.3 Retry-политика

- Exponential backoff
- Dead-letter queue
- Админ-интерфейс для мониторинга

---

## 8. POS-функциональность

- Продажа
- Возврат
- Частичная оплата
- Формирование чека
- Поддержка нескольких касс

---

## 9. WMS-функциональность

- Приёмка товара
- Перемещение
- Списание
- Инвентаризация
- Остатки в реальном времени

---

## 9.5 Полнотекстовый поиск

- Система поддерживает полнотекстовый поиск товаров через `search-service`.
- Для индексации и поиска используется **Elasticsearch**.
- `catalog-service` при создании, обновлении или удалении товара отправляет событие в **Apache Kafka**.
- `search-service` подписывается на эти события и асинхронно обновляет поисковый индекс в Elasticsearch.
- Поисковые запросы от клиента поступают в `api-gateway` и маршрутизируются на `search-service`.

---

## 10. Печать чеков

- ESC/POS
- Сетевые термопринтеры
- Библиотека: escpos-coffee
- Шаблоны чеков конфигурируемые

---

## 11. Интеграция с ОФД

- Асинхронная отправка
- Очередь чеков
- Повторная отправка при ошибках
- Хранение статусов

---

## 12. Лицензирование

### 12.1 Модель лицензии

- Привязка к hardware fingerprint
- Offline validation
- Grace-period при отсутствии интернета

### 12.2 Блокировка

- При истечении лицензии:
  - блокировка продаж
  - доступ к данным сохраняется

---

## 13. Эксплуатационные требования

- Все сервисы — systemd
- Автоматический перезапуск
- Логи через journalctl
- Обновление сервисов без переустановки ОС

---

## 14. Требования к надёжности

- Восстановление сервиса ≤ 5 секунд
- Отказ одного сервиса не должен останавливать POS
- Потеря данных недопустима

---

## 15. Этапы разработки

1. Архитектура и API контракты
2. Модель данных
3. Core backend
4. Offline-логика
5. Интеграция с оборудованием
6. Тестирование отказов
7. Документация

---

## 16. Критерии приёмки

- Работа без интернета ≥ 30 дней
- Корректная отправка чеков после восстановления связи
- Недоступность backend-сервисов напрямую из LAN
- Устойчивость к перезапуску питания

---

**Конец ТЗ**

